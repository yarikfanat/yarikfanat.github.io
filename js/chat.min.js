var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function HeadUsers(e){return React.createElement("div",{className:"head-users"},e.children)}function HeadChat(e){return React.createElement("div",{className:e.class_name,onClick:e.activateTextChat},e.children)}function HeadCamera(e){return React.createElement("div",{className:e.class_name,onClick:e.activateVideo},e.children)}function UserListBox(e){return React.createElement("ul",{className:"userslistbox"},e.children)}var ChatBox=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.scrollWindow=a.scrollWindow.bind(a),a}return _inherits(t,React.Component),_createClass(t,[{key:"componentDidUpdate",value:function(e){this.scrollWindow()}},{key:"scrollWindow",value:function(){var e=this.chatWindow.scrollHeight-this.chatWindow.clientHeight;this.chatWindow.scrollTop=e>0?e:0}},{key:"render",value:function(){var e=this;return React.createElement("div",{className:"chatbox",ref:function(t){e.chatWindow=t}},this.props.children)}}]),t}(),CameraBox=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.hangUpCall=a.hangUpCall.bind(a),a}return _inherits(t,React.Component),_createClass(t,[{key:"componentDidMount",value:function(){this.props.getRef(this.videoChat,this.videoLocal,this.receiveVideo)}},{key:"componentDidUpdate",value:function(e){this.props.isInvite&&(this.props.resetInvite(),invite()),!this.props.isFullScreen&&this.props.isClickFullScreen&&(this.props.resetClickFullScreen(),this.props.headBarVisible(!0)),this.props.isFullScreen&&this.props.isHeadBarVisible&&(this.props.headBarVisible(!1),applyAspectRatio())}},{key:"hangUpCall",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){hangUpCall()}))},{key:"render",value:function(){var e,t=this;return"skip"==this.props.display&&(e="camerabox"),"show"==this.props.display&&(e="camerabox_show"),"hide"==this.props.display&&(e="camerabox_hide"),React.createElement("div",{className:e,ref:function(e){t.videoChat=e}},React.createElement("video",{id:"received_video",autoPlay:!0,ref:function(e){t.receiveVideo=e}}),React.createElement("video",{id:"local_video",autoPlay:!0,muted:!0,ref:function(e){t.videoLocal=e}}),React.createElement("button",{id:"hangup-button",role:"button",disabled:this.props.isHungUpDisabled,onClick:this.hangUpCall},"Повесить трубку"),"show"==this.props.display?React.createElement("div",{className:"full_screen",onClick:this.props.fullScreen},React.createElement("div",{className:"square square_top_left"}),React.createElement("div",{className:"square square_top_right"}),React.createElement("div",{className:"square square_bottom_left"}),React.createElement("div",{className:"square square_bottom_right"})):null)}}]),t}();function ChatControls(e){return React.createElement("div",{className:"chat_controls"},e.children)}var ChatContainer=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.state={input_text:"",chat_text:[],user_list:null,activateVideoChat:!1,activateTextChat:!1,state_class:"state_indicator_off",isHungUpDisabled:!0,clickFullScreen:!1},a.user_name=a.props.user_name,a.serverUrl="",a.webSocket=null,a.isAlive=!1,a.isControlsDisabled=!0,a.target_user=null,a.msg_connect={type:"connect_user",user_name:null,func:null},a.myUsername=a.props.user_name,a.CameraBox=null,a.videoLocal=null,a.videoReceive=null,a.displayChatBox=!0,a.displayCameraBox="skip",a.head_camera_class="head-camera",a.head_chat_class="head-chat",a.isInvite=!1,a.isFullScreenVideo=!1,a.isRestoreScreen=!1,a.onChangeText=a.onChangeText.bind(a),a.onClickSend=a.onClickSend.bind(a),a.handlerKey=a.handlerKey.bind(a),a.setTabTextChat=a.setTabTextChat.bind(a),a.setTabVideo=a.setTabVideo.bind(a),a.getRefCameraBox=a.getRefCameraBox.bind(a),a.AnimationEnd=a.AnimationEnd.bind(a),a.onClickVideo=a.onClickVideo.bind(a),a.resetInvite=a.resetInvite.bind(a),a.onClickFullScreen=a.onClickFullScreen.bind(a),a.onResetClickFullScreen=a.onResetClickFullScreen.bind(a),a.log=a.log.bind(a),a.log_error=a.log_error.bind(a),a.reportError=a.reportError.bind(a),a.connect=a.connect.bind(a),a.ReconnectChat=a.ReconnectChat.bind(a),a.onOpenConnection=a.onOpenConnection.bind(a),a.onMessage=a.onMessage.bind(a),a.sendToServer=a.sendToServer.bind(a),a.CheckConnection=a.CheckConnection.bind(a),a.CreateUserList=a.CreateUserList.bind(a),a}return _inherits(t,React.Component),_createClass(t,[{key:"onClickFullScreen",value:function(){this.isFullScreenVideo?this.isFullScreenVideo=!1:this.isFullScreenVideo=!0,this.setState({clickFullScreen:!0})}},{key:"onResetClickFullScreen",value:function(){this.isRestoreScreen=!0,this.setState({clickFullScreen:!1})}},{key:"AnimationEnd",value:function(){this.msg_connect.user_name||"show"!=this.props.chat||confirm("Нет связи с WebSocket сервером сигнализации или он выключен. Повторить попытку?")&&(null!=this.webSocket&&this.webSocket.close(),this.connect())}},{key:"componentDidUpdate",value:function(e){this.state.activateTextChat&&this.setState({activateTextChat:!1}),this.state.activateVideoChat&&this.setState({activateVideoChat:!1})}},{key:"componentDidMount",value:function(){"none"==window.getComputedStyle(this.CameraBox,null).getPropertyValue("display")&&(this.head_camera_class="head-camera",this.head_chat_class="head-chat-select"),this.webSocket||this.connect()}},{key:"getRefCameraBox",value:function(e,t,a){this.CameraBox=e,this.videoLocal=t,this.videoReceive=a}},{key:"onChangeText",value:function(e){this.setState({input_text:e.target.value})}},{key:"onClickSend",value:function(e){var t=this.state.input_text,a={type:"message_touser",text:t,target:this.target_user,from_user:this.props.user_name};if(""!=t){this.sendToServer(a);var n=this.state.chat_text.map((function(e){return e})),i=new Date,s=i.toLocaleDateString()+" "+i.toLocaleTimeString(),o=React.createElement("span",{key:n.length},React.createElement("span",{className:"chat_date"},s),React.createElement("span",{className:"chat_send_txt"},t,React.createElement("br",null)));n.push(o),this.setState({chat_text:n}),this.setState({input_text:""})}}},{key:"handlerKey",value:function(e){13!==e.keyCode&&14!==e.keyCode||this.onClickSend()}},{key:"log",value:function(e){var t=new Date;console.log("["+t.toLocaleTimeString()+"] "+e)}},{key:"log_error",value:function(e){var t=new Date;console.trace("["+t.toLocaleTimeString()+"] "+e)}},{key:"reportError",value:function(e){this.log_error("Error "+e.name+": "+e.message)}},{key:"sendToServer",value:function(e){var t=JSON.stringify(e);this.log("Sending '"+e.type+"' message: "+t),this.webSocket.send(t)}},{key:"ReconnectChat",value:function(){confirm("Сбросить текущее websocket соединение и установить заново?")&&(this.log("Переустановка websocket соединения по запросу пользователя .."),null!=this.webSocket&&this.webSocket.close(),this.connect())}},{key:"connect",value:function(){var e="ws",t=window.location.hostname;t||(t="localhost"),console.log("Hostname: ",t),"https:"===document.location.protocol&&(e+="s"),this.serverUrl=e+"://fa97abd89c34.ngrok.io",console.log("Connecting to server: ",this.serverUrl),webSocket=this.webSocket=new WebSocket(this.serverUrl),this.webSocket.onopen=this.onOpenConnection,this.webSocket.onmessage=this.onMessage}},{key:"onOpenConnection",value:function(){console.log("connection_open .."),myUsername=this.msg_connect.user_name=this.myUsername,"yarikfanat"==this.msg_connect.user_name?this.msg_connect.func="trainer":this.msg_connect.func="client",this.isAlive=!0,this.webSocket.send(JSON.stringify(this.msg_connect)),this.checkAlive=setInterval(this.CheckConnection,15e3),this.setState({state_class:"state_indicator_on"})}},{key:"onMessage",value:function(e){var t=JSON.parse(e.data);switch(t.type){case"user_list":console.log("получено сообщение ",t.list),this.CreateUserList(t.list);break;case"message":var a=this.state.chat_text.map((function(e){return e})),n=React.createElement("span",null,React.createElement("span",{className:"chat_date"},t.date),React.createElement("span",{className:"chat_from_user"}," ",t.from_user,"=> "),t.text,React.createElement("br",null));a.push(n),this.setState({chat_text:a});break;case"video-offer":handleVideoOfferMsg(t);break;case"video-answer":handleVideoAnswerMsg(t);break;case"new-ice-candidate":handleNewICECandidateMsg(t);break;case"hang-up":handleHangUpMsg(t);break;case"hang-up-on":this.setState({isHungUpDisabled:!1});break;case"hang-up-off":this.setState({isHungUpDisabled:!0});break;case"ping_":this.sendToServer({type:"pong_"});break;case"ping":var i=new Date,s=i.toLocaleDateString()+" "+i.toLocaleTimeString();this.isAlive=!0,console.log(s," получен ping от сервера <я жив>")}}},{key:"CreateUserList",value:function(e){var t=this;var a=e.map((function(e,a){var n=function(e){for(var t=0,a=0;a<e.length;a++)t+=e.charCodeAt(a);return t.toString()}(e);return a||(target_user=t.target_user=e),React.createElement("li",{key:n},e)}));e.length>0?this.isControlsDisabled=!1:this.isControlsDisabled=!0,this.setState({user_list:a})}},{key:"CheckConnection",value:function(){var e=new Date,t=e.toLocaleDateString()+" "+e.toLocaleTimeString();1==this.isAlive?(console.log(t," checkAlive()=> соединение живое "),this.isAlive=!1,console.log("Отправляю pong серверу"),this.sendToServer({type:"pong"})):(console.log(t," checkAlive()=> соединение умерло . Нужен reconnect"),this.msg_connect.user_name=null,this.setState({state_class:"state_indicator_off"}),clearInterval(this.checkAlive),this.log("ReConnecting to server: "+this.serverUrl),null!=this.webSocket&&this.webSocket.close(),this.connect())}},{key:"resetInvite",value:function(){this.isInvite=!1}},{key:"onClickVideo",value:function(){"none"==window.getComputedStyle(this.CameraBox,null).getPropertyValue("display")?(this.isInvite=!0,this.setTabVideo()):invite()}},{key:"setTabVideo",value:function(){this.setState({activateVideoChat:!0})}},{key:"setTabTextChat",value:function(){this.setState({activateTextChat:!0})}},{key:"render",value:function(){var e,t,a=this.props.chat,n=this.state.chat_text,i=this.state.user_list,s=this.state.activateVideoChat,o=this.state.activateTextChat;s&&(this.head_camera_class="head-camera-select",this.head_chat_class="head-chat","none"==window.getComputedStyle(this.CameraBox,null).getPropertyValue("display")&&(this.displayCameraBox="show",this.displayChatBox=!1));return o&&(this.head_camera_class="head-camera",this.head_chat_class="head-chat-select",0==this.displayChatBox&&(this.displayCameraBox="hide",this.displayChatBox=!0)),a?this.displayChatBox?"show"==a?e=this.isRestoreScreen?"chat_container_restore":"chat_container animation_chat_show":(this.isRestoreScreen=!1,e="chat_container animation_chat_hide"):"show"==a?e=this.isRestoreScreen?"videochat_container_restore":"videochat_container animation_chat_show":(this.isRestoreScreen=!1,e="videochat_container animation_chat_hide"):e=this.displayChatBox?"chat_container":"videochat_container",t="state_indicator_on"==this.state.state_class?"Соединение активно":"Соединение не активно",this.state.clickFullScreen&&(e=this.isFullScreenVideo?"videochat_full_screen":"videochat_container_restore"),React.createElement("div",{className:e,onAnimationEnd:this.AnimationEnd},this.displayChatBox?React.createElement(HeadUsers,null,"Подключенные пользователи"):null,0==this.isFullScreenVideo?React.createElement(HeadChat,{class_name:this.head_chat_class,activateTextChat:this.setTabTextChat},"Текстовый чат"):null,0==this.isFullScreenVideo?React.createElement(HeadCamera,{class_name:this.head_camera_class,activateVideo:this.setTabVideo},"Видеочат"):null,this.displayChatBox?React.createElement(UserListBox,null,i):null,this.displayChatBox?React.createElement(ChatBox,null,n):null,React.createElement(CameraBox,{isFullScreen:this.isFullScreenVideo,getRef:this.getRefCameraBox,isInvite:this.isInvite,display:this.displayCameraBox,isHungUpDisabled:this.state.isHungUpDisabled,resetInvite:this.resetInvite,resetClickFullScreen:this.onResetClickFullScreen,fullScreen:this.onClickFullScreen,isClickFullScreen:this.state.clickFullScreen,headBarVisible:this.props.headBarVisible,isHeadBarVisible:this.props.isHeadBarVisible}),this.displayChatBox?React.createElement(ChatControls,null,React.createElement("div",{className:"state_block"},React.createElement("div",null,"Чат:"),React.createElement("div",{className:this.state.state_class}),React.createElement("div",null,t)),React.createElement("input",{type:"text",name:"text",size:"100",maxLength:"256",value:this.state.input_text,onChange:this.onChangeText,placeholder:"Здесь набирается текст ...",id:"text_chat",autoComplete:"off",onKeyUp:this.handlerKey,disabled:this.isControlsDisabled}),React.createElement("br",null),React.createElement("input",{type:"button",name:"send",value:"Send",id:"send",onClick:this.onClickSend,disabled:this.isControlsDisabled}),React.createElement("input",{type:"button",name:"sendVideo",value:"Видео",id:"video",disabled:this.isControlsDisabled,onClick:this.onClickVideo}),React.createElement("input",{type:"button",name:"socketReconnect",value:"Reconnect chat",id:"reconnect",onClick:this.ReconnectChat})):null)}}]),t}();