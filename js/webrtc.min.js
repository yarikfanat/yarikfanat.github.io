var webSocket=null,mediaConstraints={audio:!0,video:{aspectRatio:{ideal:1}}},myUsername=null,target_user=null,myPeerConnection=null,transceiver=null,webcamStream=null;function log(e){var n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function sendToServer(e){var n=JSON.stringify(e);log("Sending '"+e.type+"' message: "+n),webSocket.send(n)}function ReInvite(e){"Да"==e&&(hangUpCall(),invite())}async function invite(e){log("Стартую видеозвонок"),log("Inviting user "+target_user),log("Установка соединения с: "+target_user),createPeerConnection();try{webcamStream=await navigator.mediaDevices.getUserMedia(mediaConstraints),document.getElementById("local_video").srcObject=webcamStream}catch(e){return void handleGetUserMediaError(e)}try{webcamStream.getTracks().forEach(transceiver=e=>myPeerConnection.addTransceiver(e,{streams:[webcamStream]}))}catch(e){handleGetUserMediaError(e)}}async function createPeerConnection(){log("Настройка соединения..."),(myPeerConnection=new RTCPeerConnection({iceServers:[{urls:["stun:stun.stunprotocol.org","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun4.l.google.com:19302","stun:stun.ekiga.net","stun:stun.ideasip.com","stun:stun.rixtelecom.se","stun:stun.schlund.de"]},{urls:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"},{url:"turn:turn.anyfirewall.com:443?transport=tcp",credential:"webrtc",username:"webrtc"}]})).onicecandidate=handleICECandidateEvent,myPeerConnection.oniceconnectionstatechange=handleICEConnectionStateChangeEvent,myPeerConnection.onicegatheringstatechange=handleICEGatheringStateChangeEvent,myPeerConnection.onsignalingstatechange=handleSignalingStateChangeEvent,myPeerConnection.onnegotiationneeded=handleNegotiationNeededEvent,myPeerConnection.ontrack=handleTrackEvent}function handleICECandidateEvent(e){e.candidate&&(log("*** Отправка ICE кандидатов: "+e.candidate.candidate),sendToServer({type:"new-ice-candidate",target:target_user,candidate:e.candidate,from_user:myUsername}))}function handleTrackEvent(e){log("*** Track event"),document.getElementById("received_video").srcObject=e.streams[0],sendToServer({type:"hang-up-on",target:myUsername,from_user:myUsername})}async function handleNegotiationNeededEvent(){log("*** Negotiation needed");try{log("---\x3e Creating offer");const e=await myPeerConnection.createOffer();if("stable"!=myPeerConnection.signalingState)return void log("     -- The connection isn't stable yet; postponing...");log("---\x3e Setting local description to the offer"),await myPeerConnection.setLocalDescription(e),log("---\x3e Отсылаю видео-предложение на удаленный узел"),sendToServer({from_user:myUsername,target:target_user,type:"video-offer",sdp:myPeerConnection.localDescription})}catch(e){log("*** The following error occurred while handling the negotiationneeded event:"),reportError(e)}}function handleICEConnectionStateChangeEvent(e){switch(log("*** ICE connection state changed to "+myPeerConnection.iceConnectionState),myPeerConnection.iceConnectionState){case"closed":case"failed":case"disconnected":closeVideoCall()}}function handleSignalingStateChangeEvent(e){switch(log("*** WebRTC signaling state changed to: "+myPeerConnection.signalingState),myPeerConnection.signalingState){case"closed":closeVideoCall()}}function log_error(e){var n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+e)}function handleICEGatheringStateChangeEvent(e){log("*** ICE gathering state changed to: "+myPeerConnection.iceGatheringState),"complete"==myPeerConnection.iceGatheringState&&applyAspectRatio()}function reportError(e){log_error(`Error ${e.name}: ${e.message}`)}function handleGetUserMediaError(e){switch(log_error(e),e.name){case"NotFoundError":alert("Не могу начать видеозвонок, так как не обнаружены камера/микрофон");break;case"SecurityError":case"PermissionDeniedError":break;default:alert("Ошибка открытия вашей камеры/микрофона: "+e.message)}closeVideoCall()}function closeVideoCall(){var e=document.getElementById("local_video");log("Closing the call"),myPeerConnection&&(log("--\x3e Closing the peer connection"),myPeerConnection.ontrack=null,myPeerConnection.onnicecandidate=null,myPeerConnection.oniceconnectionstatechange=null,myPeerConnection.onsignalingstatechange=null,myPeerConnection.onicegatheringstatechange=null,myPeerConnection.onnotificationneeded=null,myPeerConnection.getTransceivers().forEach((e=>{e.stop()})),e.srcObject&&(e.pause(),e.srcObject.getTracks().forEach((e=>{e.stop()}))),myPeerConnection.close(),myPeerConnection=null,webcamStream=null),sendToServer({type:"hang-up-off",target:myUsername,from_user:myUsername})}async function handleVideoOfferMsg(e){log("Received video chat offer from "+(target_user=e.from_user)),myPeerConnection||createPeerConnection();var n=new RTCSessionDescription(e.sdp);if("stable"!=myPeerConnection.signalingState)return log("  - But the signaling state isn't stable, so triggering rollback"),void await Promise.all([myPeerConnection.setLocalDescription({type:"rollback"}),myPeerConnection.setRemoteDescription(n)]);if(log("  - Setting remote description"),await myPeerConnection.setRemoteDescription(n),!webcamStream){try{webcamStream=await navigator.mediaDevices.getUserMedia(mediaConstraints)}catch(e){return void handleGetUserMediaError(e)}document.getElementById("local_video").srcObject=webcamStream;try{webcamStream.getTracks().forEach(transceiver=e=>myPeerConnection.addTransceiver(e,{streams:[webcamStream]}))}catch(e){handleGetUserMediaError(e)}}log("---\x3e Отправка видео-ответа вызывающему"),await myPeerConnection.setLocalDescription(await myPeerConnection.createAnswer()),sendToServer({from_user:myUsername,target:target_user,type:"video-answer",sdp:myPeerConnection.localDescription})}async function handleVideoAnswerMsg(e){log("*** Call recipient has accepted our call");var n=new RTCSessionDescription(e.sdp);await myPeerConnection.setRemoteDescription(n).catch(reportError)}async function handleNewICECandidateMsg(e){var n=new RTCIceCandidate(e.candidate);log("*** Добавляю принятых ICE кандидатов: "+JSON.stringify(n));try{await myPeerConnection.addIceCandidate(n)}catch(e){reportError(e)}}function handleHangUpMsg(e){log("*** Принято hang up сообщение от удаленного узла"),closeVideoCall()}function hangUpCall(){var e={from_user:myUsername,target:target_user,type:"hang-up"};closeVideoCall(),sendToServer(e)}function applyAspectRatio(){var e=navigator.mediaDevices.getSupportedConstraints();if(console.log("supports contraints->",e),e.width){var n=document.getElementById("received_video");console.log("Установка  параметров <Receive видео> :width=",n.clientWidth," height=",n.clientHeight);try{n.srcObject.getVideoTracks().forEach((e=>{e.applyConstraints({width:{ideal:n.clientWidth},height:{ideal:n.clientHeight}}).then((()=>{console.log("Sucessfull applyConstraints width=",n.clientWidth,"Height=",n.clientHeight)})).catch((e=>{console.log("The constraints could not be satisfied by the available devices")}))}))}catch(e){console.error("Ошибка при установке новых настроек экрана Receive видео->",e.message)}}else console.log('getSupportedConstraints() :ограничение ["width"] не поддерживается ')}